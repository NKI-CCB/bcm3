Refactored for use in BCM, e.g. using MatrixReal type.
